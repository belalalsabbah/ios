name: iOS Simulator Build

on:
  workflow_dispatch:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-ios-simulator:
    name: ğŸ‰ Build iOS Simulator App for twonet_customer
    runs-on: macos-latest
    
    steps:
      - name: ğŸ“‚ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          architecture: x64
      
      - name: ğŸ“¦ Get Flutter packages
        run: flutter pub get

      - name: ğŸ§¹ Clean iOS folder
        run: |
          cd ios
          rm -rf Pods Podfile.lock
          cd ..

      - name: ğŸ”„ Install CocoaPods
        run: |
          cd ios
          pod install --repo-update
          cd ..

      # âœ… Ù‡Ø°Ù‡ Ù‡ÙŠ Ø§Ù„Ø®Ø·ÙˆØ© Ø§Ù„Ø³Ø­Ø±ÙŠØ©: Ø¨Ù†Ø§Ø¡ Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø­Ø§ÙƒÙŠ
      - name: ğŸ—ï¸ Build iOS Simulator (Debug)
        run: flutter build ios --simulator

      # â„¹ï¸ Ù…ÙˆÙ‚Ø¹ Ù…Ù„Ù Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù†Ø§ØªØ¬ Ø¹Ù† Ø§Ù„Ø®Ø·ÙˆØ© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
      - name: ğŸ“ Prepare .app bundle for upload
        run: |
          # Ù…Ø³Ø§Ø± Ù…Ø¬Ù„Ø¯ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ (Ø§Ø³Ù…Ù‡ Runner.app)
          APP_PATH="build/ios/iphonesimulator/Runner.app"
          
          # Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù…Ø¬Ù„Ø¯
          if [ -d "$APP_PATH" ]; then
            echo "âœ… Simulator app bundle found at $APP_PATH"
            
            # ØªØºÙŠÙŠØ± Ø§Ù„Ø§Ø³Ù… Ù„ÙŠØ´Ù…Ù„ Ø±Ù‚Ù… Ø§Ù„Ø¨Ù†Ø§Ø¡
            mv "$APP_PATH" "build/ios/iphonesimulator/twonet_customer_${{ github.run_number }}.app"
            echo "ğŸ“¦ App bundle renamed for upload."
          else
            echo "âŒ Simulator app bundle not found!"
            exit 1
          fi

      # ğŸ“¦ Ù†Ø¶ØºØ· Ù…Ø¬Ù„Ø¯ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¹Ù„Ù‰ Ø´ÙƒÙ„ ZIP Ù„Ø³Ù‡ÙˆÙ„Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù…Ù† GitHub
      - name: ğŸ“¦ Zip .app bundle
        run: |
          cd build/ios/iphonesimulator
          zip -r "twonet_customer_${{ github.run_number }}.zip" "twonet_customer_${{ github.run_number }}.app"
          echo "ğŸ—œï¸ App bundle zipped successfully."

      - name: ğŸ“¤ Upload Simulator Build as artifact
        uses: actions/upload-artifact@v4
        with:
          name: twonet_customer_simulator_build
          path: build/ios/iphonesimulator/twonet_customer_${{ github.run_number }}.zip